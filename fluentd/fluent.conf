<source>
  # Вхідний плагін: Fluentd приймає події по протоколу forward.
  # Саме сюди відправляє Docker logging driver `fluentd` (порт 24224).
  @type forward
  port 24224
  # Слухаємо на всіх інтерфейсах у контейнері.
  bind 0.0.0.0
</source>

<match **>
  # Усі події (будь-які теги) відправляємо в Elasticsearch.
  @type elasticsearch
  # Усередині docker-compose мережі звертаємось по імені сервісу `elasticsearch`.
  host elasticsearch
  port 9200

  # Elasticsearch може стартувати довше, ніж Fluentd.
  # Тому робимо retry при визначенні версії ES і НЕ падаємо, якщо на початку ES ще недоступний.
  max_retry_get_es_version 30
  fail_on_detecting_es_version_retry_exceed false
  # Підказка плагіну, яку версію ES очікувати, якщо auto-detect тимчасово не спрацював.
  default_elasticsearch_version 7

  # Аналогічно: retry при встановленні index template.
  max_retry_putting_template 30
  fail_on_putting_template_retry_exceed false

  # Формат індексів як у Logstash: fluentd-YYYY.MM.DD
  logstash_format true
  # Префікс для індексів (разом з logstash_format дає `fluentd-*`).
  logstash_prefix fluentd

  # Додаємо тег події у документ, щоб у Kibana можна було фільтрувати, наприклад:
  # - tag:"monitoring-2" (логи Node.js контейнера)
  # - tag:"logtest" (тестовий контейнер)
  include_tag_key true
  tag_key tag
</match>